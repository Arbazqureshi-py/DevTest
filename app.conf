upstream channels-backend {
  server localhost:8001;
}
limit_req_zone $binary_remote_addr zone=periponapi:10m rate=30r/s;
limit_req_zone $binary_remote_addr zone=periponjenkins:1m rate=2r/s;
limit_conn_zone $binary_remote_addr zone=limitconnbyaddr:20m;
limit_conn_status 429;
server {
  listen 80;
  location = /favicon.ico { access_log off; log_not_found off; }
  proxy_connect_timeout   180;
  proxy_send_timeout      180;
  proxy_read_timeout      3600;
  send_timeout            180;
  client_body_timeout     180;
  client_max_body_size    200M;
  #limit_req zone=periponapi;
  #limit_conn limitconnbyaddr 50;
  #app_protect_dos_enable on;


  location /static/ {
    root /var/lib/jenkins/workspace/Backend;


  }
  location /media/ {
    root /var/lib/jenkins/workspace/Backend;


  }

  listen 443 ssl; 

  server_name api.themedius.ai www.api.themedius.ai campaign.themedius.ai www.campaign.themedius.ai dev.api.themedius.ai www.dev.api.themedius.ai dev.campaign.themedius.ai www.dev.campaign.themedius.ai voicebot.themedius.ai www.voicebot.themedius.ai;
  error_log /var/lib/jenkins/workspace/Backend/logs/error.log;
  access_log /var/lib/jenkins/workspace/Backend/logs/access.log;

  ssl_certificate /home/ubuntu/cert/fullchain.cer; # managed by Certbot
  ssl_certificate_key /home/ubuntu/cert/privatekey.pem; # managed by Certbot
  ssl_password_file /home/ubuntu/cert/pass.txt;

#  location ~ ^/(dashboard/api|intimation_call|incoming_call|recording_save|incoming-sms|ivr_missed_calls|pre_call_notification|latest_incoming_call|new_incoming_call|new_latest_incoming_call|new_latest_helpline_number_incoming_call|call_picked_up|gupshup_webhook|gupshup_inbound_message|gupshup_realtime_delivery_report|gupshup_inbound_message_career|gupshup_realtime_delivery_report_career|wati_webhook|wati_web_hook|whatsapp-flow-webhook|webhook-wati|webhook-wati-v2|chatbot_webhook|awsemail/api|aws_email_delivery_status|call/api/save_call_response_webhook|freshdesk/api/webhook|freshdesk/api/email_webhook|message91/api/message_response_webhook|campaigns/api/ivr_campaign_sqs|dashboard/api/lambda_update_exotel_call_count_batchwise|pre_litigation/api/wap_bounce_lambda|dashboard/api/save_payment_link_scrapping|pre_litigation/api/notice_response_lambda|campaigns/api/final_ivr_campaign_sqs|dashboard/api/update-payment-status-lambda|awsemail/api/update-email-status-lambda|awsemail/api/update-email-status-lambda-candidate|pre_litigation/api/update-pdf-link-lambda|fir/api/update_custom_fir_formats|pre_litigation/api/send_email_sample_notice|dashboard/api/update-wap-collection-lambda|fir/api/update-wap-lambda|pre_litigation/api/update-wap-lambda-campaign|pre_litigation/api/update-wap-lambda|pre_litigation/api/update-wap-lambda-campaign-bulk|pre_litigation/api/update-wap-lambda-campaign-gupshup|pre_litigation/api/update-wap-lambda-campaign-candidate|awsemail/api/update-bounce-email-lambda|dashboard/api/wap-status-lambda|dashboard/api/handle_errors/) {
#    include proxy_params;
#    proxy_pass http://unix:/home/ubuntu/project/app.sock;
#    }

#  location / {
#    satisfy any;
#    allow 20.198.77.171;
#    allow 20.219.21.18;
#    allow 20.219.163.82;
#    allow 4.224.29.71;
#    allow 20.219.57.210;
#    allow 40.80.85.141;
#    allow 20.219.164.137;
#    deny all;
#    include proxy_params;
#    proxy_pass http://unix:/home/ubuntu/project/app.sock;
#    }
  location / {
    include proxy_params;
    proxy_pass http://unix:/home/ubuntu/project/app.sock;
    }

  location /ws/ {
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_redirect off;
    proxy_pass http://127.0.0.1:8001;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Host $server_name;
    }


  if ($scheme = "http") {
    return 301 https://$host$request_uri;
  }
  if ($scheme = "ws") {
    return 301 wss://$host$request_uri;
  }
}


#Jenkins Configuration

server{
  listen 80;
  server_name devops.themedius.ai www.devops.themedius.ai devops.campaign.themedius.ai www.devops.campaign.themedius.ai devops.dev.campaign.themedius.ai devops.dev.api.themedius.ai devops.voicebot.themedius.ai;
  return 301 https://$server_name$request_uri;
}

server{
  listen 443 ssl; 

  server_name devops.themedius.ai www.devops.themedius.ai devops.campaign.themedius.ai www.devops.campaign.themedius.ai devops.dev.campaign.themedius.ai devops.dev.api.themedius.ai devops.voicebot.themedius.ai;
  error_log /var/lib/jenkins/workspace/Backend/logs/error.log;
  access_log /var/lib/jenkins/workspace/Backend/logs/access.log;
  #app_protect_dos_enable on;
  #limit_conn limitconnbyaddr 2;
  #limit_req zone=periponjenkins;
  # RSA certificate
  ssl_certificate /home/ubuntu/cert/fullchain.cer; # managed by Certbot
  ssl_certificate_key /home/ubuntu/cert/privatekey.pem; # managed by Certbot
  ssl_password_file /home/ubuntu/cert/pass.txt;

  location / {
  allow 20.219.164.137;
  allow 20.193.155.184;
  deny all;
  include proxy_params;
  proxy_pass http://127.0.0.1:8080;
  }
}
